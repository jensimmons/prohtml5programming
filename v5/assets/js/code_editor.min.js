/* initializes all static code blocks within a figure as instances of codemirror for formatting purposes */function formatStaticCode(){var e=[],t=jQuery("figure.listing"),n,r,i,s,o,u,a='<div class="static-code-container"></div>';t.each(function(){$figure=jQuery(this);r=jQuery("pre:first",$figure);$code=jQuery("code:first",r);n=$code.text();u=$code.data("cm-mode")?$code.data("cm-mode"):"javascript";i=$code.data("bold")?$code.data("bold").split(","):[];s=jQuery(a).insertAfter(r).get(0);r.remove();o=CodeMirror(s,{mode:u,tabMode:"indent",theme:"static",readOnly:!0,lineWrapping:!0,lineNumbers:!1,pollInterval:3e3,value:n});e.push(o);if(i.length)for(var t=0,f=i.length;t<f;t++)o.setLineClass(parseInt(i[t]),"cm-strong")})}function updatePreview(e){var t=e[0],n=jQuery("#preview",t.container).get(0),r=n.contentDocument||n.contentWindow.document;r.open();r.write(t.editor.getValue());r.close()}function initCodeEditors(){jQuery("figure.listing[data-listing]").each(function(){var e=jQuery(this),t=e.data("listing");jQuery("figcaption:first",e).after(jQuery(inlineEditors.editorContainerTemplate));jQuery(".button",e).data("listing",t)});jQuery(".show-inline-editor:not('.open')").bind("click",function(e){e.stopPropagation();e.preventDefault();var t=jQuery(this),n=t.parents("figure:first"),r=jQuery(this).data("listing");t.addClass("open");n.addClass("open-editor");inlineEditors[r]=new inlineEditor(t);jQuery(".static-code-container:first",n).hide()});jQuery(".close-inline-editor").bind("click",function(e){e.stopPropagation();e.preventDefault();var t=jQuery(this),n=t.parents("figure:first"),r=jQuery(this).data("listing");inlineEditors[r].removeEditor();inlineEditors[r]=null;jQuery(".static-code-container:first",n).show();t.siblings(".show-inline-editor:first").removeClass("open");n.removeClass("open-editor")})}function checkStorageSupport(){window.localStorage&&(inlineEditors.localStorageSupport=!0)}var inlineEditors={editorContainerTemplate:'<div class="editor-trigger">\n<a href="#inline-code-example" class="show-inline-editor button">Open editor</a>\n<a href="#close-inline-code-example" class="close-inline-editor button">Close editor</a>\n</div>\n\n<div class="inline-codeview-container" style="width: 100%; float: left; padding-top: 1.5em; "></div>',editorTemplate:'<div id="code-view-source">\n\n<div class="code-editor-container">\n<iframe id="preview"></iframe>\n</div>\n\n<div class="code-mirror-container">\n<textarea id="code" name="code">\n</textarea>\n</div>\n<div class="control-bar">\n<div class="control save">Save</div>\n<div class="control reset">Reset</div>\n</div>\n</div>',localStorageSupport:!1},inlineEditor=function(e){var t=this;this.trigger=e;this.delay;this.listingNumber=e.data("listing");inlineEditors[this.listingNumber]=this;this.container=this.trigger.parents(".listing:first").find(".inline-codeview-container");this.container.html(jQuery(inlineEditors.editorTemplate));this.resetControl=jQuery(".control-bar .control.reset",this.container);this.saveControl=jQuery(".control-bar .control.save",this.container);this.previewFrame=jQuery("#preview",this.container).get(0);this.previewHeight=this.container.parents(".listing:first").data("preview-height")+"px";this.editor=CodeMirror.fromTextArea(jQuery("#code",this.container).get(0),{mode:"text/html",tabMode:"indent",theme:"ambiance",lineWrapping:!0,lineNumbers:!0,onChange:function(){window.clearTimeout(t.delay);t.delay=window.setTimeout(updatePreview,300,[t])}});this.resetControl.bind("click",function(e){t.reset()});this.saveControl.bind("click",function(e){t.save()});this.removeEditor=function(){window.clearTimeout(t.delay);t.editor=null;t.container.html("")};this.retrieve();jQuery("#preview",this.container).height(this.previewHeight)};inlineEditor.prototype.retrieve=function(){inlineEditors.localStorageSupport&&localStorage[this.listingNumber]?this.editor.setValue(localStorage[this.listingNumber]):this.reset()};inlineEditor.prototype.clearSaved=function(){inlineEditors.localStorageSupport&&localStorage[this.listingNumber]&&localStorage.removeItem(this.listingNumber)};inlineEditor.prototype.save=function(){inlineEditors.localStorageSupport&&localStorage.setItem(this.listingNumber,this.editor.getValue())};inlineEditor.prototype.reset=function(){this.editor.setValue(inlineEditors.codeListings[this.listingNumber].code);this.clearSaved()};jQuery(function(){checkStorageSupport();initCodeEditors();formatStaticCode()});